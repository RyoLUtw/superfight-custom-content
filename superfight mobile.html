<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <!-- Set viewport for mobile portrait orientation and responsiveness -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Superfight Modified Game</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 10px;
            background: #f9f9f9;
        }

        h1,
        h2 {
            text-align: center;
            margin: 10px 0;
            /* Added margin for better readability */
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 10px;
        }

        th,
        td {
            border: 1px solid #aaa;
            padding: 5px;
            text-align: center;
        }

        .hidden {
            display: none;
        }

        .timer {
            font-size: 2em;
            text-align: center;
            margin: 10px 0;
            border: 2px solid black;
            /* Border for the timer section */
            padding: 10px;
        }

        .scoreboard {
            font-size: 1.2em;
            margin: 10px;
            text-align: center;
        }

        .scoreboard div {
            margin: 5px;
        }

        .container {
            max-width: 500px;
            margin: auto;
        }

        /* Black and white aesthetic for buttons */
        button {
            background-color: black;
            color: white;
            border: 2px solid white;
            border-radius: 5px;
            padding: 10px 20px;
            font-size: 1em;
            cursor: pointer;
            margin: 5px;
            height: 5vh;
        }

        button:hover {
            background-color: white;
            color: black;
            border: 2px solid black;
        }

        /* Center the Gain Weakness button */
        #gainWeaknessButton {
            display: block;
            margin: 10px auto;
        }

        /* Border and padding for card preview section */
        #csvPreviewSection {
            border: 2px solid black;
            padding: 10px;
            margin-bottom: 10px;
        }

        /* Border and padding for final Result */
        #finalResult {
            border: 2px solid black;
            padding: 10px;
            margin-bottom: 10px;
        }

        /* Make dropdowns larger and adjust font sizes */
        select {
            min-height: 5vh;
            /* At least 10% of viewport height */
            font-size: 3vh;
            /* So that text scales with height */
            width: 100%;
            box-sizing: border-box;
            margin-top: 3vh
        }

        /* Labels sized to be half the height of the select element (i.e. about 5vh) */
        label {
            font-size: 5vh;
            display: block;
            margin-bottom: 5px;
        }

        /* Responsive adjustments */
        @media (max-width: 600px) {
            button {
                padding: 10px;
                font-size: 1em;
            }

            select {
                font-size: 5vh;
            }

            label {
                font-size: 5vh;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>SUPERFIGHT</h1>

        <!-- CSV Upload Section -->
        <div id="uploadSection">
            <input type="file" id="csvFileInput" accept=".csv">
            <button id="loadCsvButton">Load CSV</button>
        </div>

        <!-- CSV Preview Section -->
        <div id="csvPreviewSection" class="hidden">
            <h2>Card Preview</h2>
            <table id="csvPreview"></table>
            <button id="collectCardsButton">Collect Cards</button>
        </div>

        <!-- Card Selection Section -->
        <div id="cardSelection" class="hidden">
            <div id="dropdowns">
                <div>
                    <label for="fighterSelect">Fighter:</label>
                    <select id="fighterSelect"></select>
                </div>
                <div>
                    <label for="perkSelect">Perk:</label>
                    <select id="perkSelect"></select>
                </div>
                <button id="confirmSelectionButton">Confirm Selection</button>
            </div>
        </div>

        <!-- Final Result Section -->
        <div id="finalResult" class="hidden">
            <!-- Fighter is displayed in h1 without a label -->
            <h1 id="fighterDisplay"></h1>
            <!-- Perk in h2 with dark blue and weakness in h2 with red (with added margin) -->
            <h2 id="perkDisplay" style="color: darkblue;"></h2>
            <h2 id="weaknessDisplay" class="hidden" style="color: red; margin-top: 10px;"></h2>
            <button id="gainWeaknessButton">Gain Weakness</button>
        </div>

        <!-- Timer Interface Section -->
        <div id="timerInterface" class="hidden">
            <div class="timer" id="timerDisplay">01:00</div>
            <div style="text-align:center;">
                <button id="decreaseTimer">-10s</button>
                <button id="increaseTimer">+10s</button>
            </div>
            <div style="text-align:center;">
                <button id="startTimer">Start</button>
                <button id="pauseTimer">Pause</button>
                <button id="resetTimer">Reset</button>
            </div>
        </div>

        <!-- Scoreboard Interface Section -->
        <div id="scoreboardInterface" class="hidden">
            <div class="scoreboard">
                <h2>Score Board</h2>
                <div>Victory Rate: <span id="victoryRate">0%</span></div>
                <div>
                    Wins: <button id="decrementWins">-</button>
                    <span id="winCount">0</span>
                    <button id="incrementWins">+</button>
                </div>
                <div>
                    Losses: <button id="decrementLosses">-</button>
                    <span id="lossCount">0</span>
                    <button id="incrementLosses">+</button>
                </div>
                <button id="newRoundButton">New Round</button>
            </div>
        </div>
    </div> <!-- end container -->

    <script>
        // Global variables for storing CSV data and game state.
        let csvData = [];   // Array of objects: { fighter, perk, weakness }
        let fighterCards = [];
        let perkCards = [];
        let timerTime = 60;  // Timer default in seconds (1 minute)
        let timerInterval = null;
        let wins = 0;
        let losses = 0;

        // Prevent accidental refresh/leave.
        window.addEventListener('beforeunload', function (e) {
            e.preventDefault();
            e.returnValue = '';
        });

        document.addEventListener('DOMContentLoaded', function () {

            // CSV Load: Read CSV, parse it, display preview, then hide the upload section.
            document.getElementById('loadCsvButton').addEventListener('click', function () {
                const fileInput = document.getElementById('csvFileInput');
                if (fileInput.files.length === 0) {
                    alert('Please select a CSV file first.');
                    return;
                }
                const file = fileInput.files[0];
                const reader = new FileReader();
                reader.onload = function (e) {
                    const text = e.target.result;
                    parseCSV(text);
                    displayPreview();
                    // Hide the upload section once CSV is loaded.
                    document.getElementById('uploadSection').classList.add('hidden');
                    // Show the preview section.
                    document.getElementById('csvPreviewSection').classList.remove('hidden');
                };
                reader.readAsText(file);
            });

            // Parse CSV text into an array of objects.
            function parseCSV(text) {
                const lines = text.split(/\r?\n/).filter(line => line.trim() !== '');
                // If the first row contains header keywords, remove it.
                if (lines.length > 0 &&
                    lines[0].toLowerCase().includes('fighter') &&
                    lines[0].toLowerCase().includes('perk') &&
                    lines[0].toLowerCase().includes('weakness')) {
                    lines.shift();
                }
                csvData = lines.map(line => {
                    const parts = line.split(',');
                    return {
                        fighter: parts[0].trim(),
                        perk: parts[1].trim(),
                        weakness: parts[2].trim()
                    };
                });
            }

            // Display a preview table of all cards.
            function displayPreview() {
                const table = document.getElementById('csvPreview');
                table.innerHTML = ''; // Clear previous content
                const header = document.createElement('tr');
                ['Fighter', 'Perk', 'Weakness'].forEach(text => {
                    const th = document.createElement('th');
                    th.textContent = text;
                    header.appendChild(th);
                });
                table.appendChild(header);
                csvData.forEach(card => {
                    const row = document.createElement('tr');
                    ['fighter', 'perk', 'weakness'].forEach(key => {
                        const cell = document.createElement('td');
                        cell.textContent = card[key];
                        row.appendChild(cell);
                    });
                    table.appendChild(row);
                });
            }

            // Collect Cards: Randomly select 3 fighters and 4 perks,
            // then hide the preview table and the collect cards button.
            document.getElementById('collectCardsButton').addEventListener('click', function () {
                if (csvData.length === 0) {
                    alert('No card data loaded!');
                    return;
                }
                // Hide the preview table and button to avoid repeat collection.
                document.getElementById('csvPreviewSection').classList.add('hidden');
                document.getElementById('collectCardsButton').classList.add('hidden');

                // Randomly select fighter and perk cards.
                fighterCards = [];
                perkCards = [];
                for (let i = 0; i < 3; i++) {
                    const randomIndex = Math.floor(Math.random() * csvData.length);
                    fighterCards.push(csvData[randomIndex].fighter);
                }
                for (let i = 0; i < 4; i++) {
                    const randomIndex = Math.floor(Math.random() * csvData.length);
                    perkCards.push(csvData[randomIndex].perk);
                }
                populateDropdown('fighterSelect', fighterCards);
                populateDropdown('perkSelect', perkCards);
                // Reveal the card selection interface.
                document.getElementById('cardSelection').classList.remove('hidden');
            });

            // Populate a dropdown with given items.
            function populateDropdown(selectId, items) {
                const selectElem = document.getElementById(selectId);
                selectElem.innerHTML = '';
                items.forEach(function (item) {
                    const option = document.createElement('option');
                    option.value = item;
                    option.textContent = item;
                    selectElem.appendChild(option);
                });
            }

            // Confirm the fighter and perk selection.
            document.getElementById('confirmSelectionButton').addEventListener('click', function () {
                const fighter = document.getElementById('fighterSelect').value;
                const perk = document.getElementById('perkSelect').value;
                // Hide the dropdowns.
                document.getElementById('dropdowns').classList.add('hidden');
                // Display the confirmed fighter (h1) and perk (h2).
                document.getElementById('fighterDisplay').textContent = fighter;
                document.getElementById('perkDisplay').textContent = perk;
                // Ensure weakness is cleared/hidden.
                const weaknessElem = document.getElementById('weaknessDisplay');
                weaknessElem.textContent = '';
                weaknessElem.classList.add('hidden');
                // Show the final result section.
                document.getElementById('finalResult').classList.remove('hidden');
            });

            // Gain Weakness: Randomly select and display a weakness, then show timer.
            document.getElementById('gainWeaknessButton').addEventListener('click', function () {
                if (csvData.length === 0) {
                    alert('No card data loaded!');
                    return;
                }
                const randomIndex = Math.floor(Math.random() * csvData.length);
                const weakness = csvData[randomIndex].weakness;
                const weaknessElem = document.getElementById('weaknessDisplay');
                weaknessElem.textContent = weakness;
                weaknessElem.classList.remove('hidden');
                // Hide the Gain Weakness button immediately.
                this.style.display = 'none';
                // Show the timer interface.
                document.getElementById('timerInterface').classList.remove('hidden');
            });

            // Timer adjustment buttons.
            document.getElementById('increaseTimer').addEventListener('click', function () {
                timerTime += 10;
                updateTimerDisplay();
            });
            document.getElementById('decreaseTimer').addEventListener('click', function () {
                if (timerTime >= 10) {
                    timerTime -= 10;
                    updateTimerDisplay();
                }
            });
            // Update timer display in MM:SS format.
            function updateTimerDisplay() {
                const minutes = Math.floor(timerTime / 60);
                const seconds = timerTime % 60;
                document.getElementById('timerDisplay').textContent =
                    (minutes < 10 ? '0' : '') + minutes + ':' +
                    (seconds < 10 ? '0' : '') + seconds;
            }

            // Timer controls: Start, Pause, Reset.
            document.getElementById('startTimer').addEventListener('click', function () {
                if (timerInterval) return; // Prevent multiple intervals.
                timerInterval = setInterval(function () {
                    if (timerTime > 0) {
                        timerTime--;
                        updateTimerDisplay();
                    } else {
                        clearInterval(timerInterval);
                        timerInterval = null;
                        // When timer ends, hide timer and show scoreboard.
                        document.getElementById('timerInterface').classList.add('hidden');
                        document.getElementById('scoreboardInterface').classList.remove('hidden');
                    }
                }, 1000);
            });
            document.getElementById('pauseTimer').addEventListener('click', function () {
                if (timerInterval) {
                    clearInterval(timerInterval);
                    timerInterval = null;
                }
            });
            document.getElementById('resetTimer').addEventListener('click', function () {
                if (timerInterval) {
                    clearInterval(timerInterval);
                    timerInterval = null;
                }
                timerTime = 60; // Reset to default 1 minute
                updateTimerDisplay();
            });

            // Scoreboard controls.
            function updateVictoryRate() {
                const total = wins + losses;
                const rate = total > 0 ? Math.round((wins / total) * 100) : 0;
                document.getElementById('victoryRate').textContent = rate + '%';
            }
            document.getElementById('incrementWins').addEventListener('click', function () {
                wins++;
                document.getElementById('winCount').textContent = wins;
                updateVictoryRate();
            });
            document.getElementById('decrementWins').addEventListener('click', function () {
                if (wins > 0) wins--;
                document.getElementById('winCount').textContent = wins;
                updateVictoryRate();
            });
            document.getElementById('incrementLosses').addEventListener('click', function () {
                losses++;
                document.getElementById('lossCount').textContent = losses;
                updateVictoryRate();
            });
            document.getElementById('decrementLosses').addEventListener('click', function () {
                if (losses > 0) losses--;
                document.getElementById('lossCount').textContent = losses;
                updateVictoryRate();
            });

            // New Round: Reset the game interface for a new round without clearing the scoreboard.
            document.getElementById('newRoundButton').addEventListener('click', function () {
                // Hide final result, timer interface, and card selection.
                document.getElementById('finalResult').classList.add('hidden');
                document.getElementById('timerInterface').classList.add('hidden');
                document.getElementById('cardSelection').classList.add('hidden');
                // Reset dropdowns for a fresh card selection.
                document.getElementById('dropdowns').classList.remove('hidden');
                document.getElementById('fighterSelect').innerHTML = '';
                document.getElementById('perkSelect').innerHTML = '';
                // Re-enable and show Gain Weakness button.
                const gainWeaknessBtn = document.getElementById('gainWeaknessButton');
                gainWeaknessBtn.disabled = false;
                gainWeaknessBtn.style.display = 'block';
                // Reset timer.
                timerTime = 60;
                updateTimerDisplay();
                // Re-show the Collect Cards button.
                document.getElementById('collectCardsButton').classList.remove('hidden');
            });
        });
    </script>
</body>

</html>